# 关联分析功能文档

## 功能概述

新增的关联分析功能允许用户分析水厂指标之间的关系，支持多项式回归和神经网络回归两种分析方法。

## 功能入口

在主页面右上角添加了"关联分析"按钮，点击后跳转到独立的关联分析页面。

## 主要功能

### 1. 变量配置
- **自变量（Independent Variables）**: 支持添加多个自变量，可从数据库字段列表中选择
- **因变量（Dependent Variable）**: 选择一个作为预测目标的变量
- **分析类型**: 
  - 多项式回归：可配置多项式阶数（1-5阶）
  - 神经网络回归：可配置隐藏层结构（如：100,50）
- **时间范围**: 选择分析的开始和结束日期

### 2. 分析结果展示

#### 统计指标
- **训练集 R²**: 训练数据的决定系数
- **测试集 R²**: 测试数据的决定系数
- **训练集 MSE**: 训练数据的均方误差
- **测试集 MSE**: 测试数据的均方误差

#### 可视化图表
1. **预测值 vs 实际值**: 散点图展示模型预测效果
2. **残差分析**: 展示预测误差分布
3. **特征重要性**: 柱状图显示各变量的重要程度（神经网络回归）
4. **回归系数**: 显示各变量的系数值

#### 回归方程
显示完整的回归方程，便于理解变量之间的数学关系。

## 技术实现

### 前端
- **页面**: `/app/correlation/page.tsx`
- **路由**: `/correlation`
- **图表库**: recharts
- **UI框架**: React + TailwindCSS

### 后端 API

#### 1. 获取字段列表
- **路径**: `/api/correlation/fields`
- **方法**: GET
- **返回**: 数据库中所有数值型字段列表

#### 2. 执行分析
- **路径**: `/api/correlation/analyze`
- **方法**: GET
- **参数**:
  - `x_fields`: 自变量列表（逗号分隔）
  - `y_field`: 因变量
  - `start_date`: 开始日期
  - `end_date`: 结束日期
  - `analysis_type`: 分析类型（polynomial/neural_network）
  - `degree`: 多项式阶数（仅多项式回归）
  - `hidden_layers`: 隐藏层结构（仅神经网络回归）

### 数据处理
1. **数据清洗**: 自动移除异常值（使用IQR方法）
2. **数据分割**: 80%训练集，20%测试集
3. **特征工程**: 支持多项式特征生成
4. **标准化**: 神经网络回归自动进行数据标准化

## 算法实现

### 多项式回归
- 使用正规方程求解: β = (X^T X)^(-1) X^T y
- 支持1-5阶多项式
- 自动生成多项式特征

### 神经网络回归（简化版）
- 基于线性回归实现
- 支持多层感知器结构配置
- 计算特征重要性

## 使用示例

### 示例1: 分析流量与压力的关系
1. 自变量: `flow_out`
2. 因变量: `pressure_out`
3. 分析类型: 多项式回归（2阶）
4. 时间范围: 最近7天

### 示例2: 多变量分析
1. 自变量: `flow_out`, `flow_in`, `power`
2. 因变量: `pressure_out`
3. 分析类型: 神经网络回归
4. 隐藏层: 100,50

## 参考脚本

实现参考了以下Python分析脚本：
- `/Users/zhengbiaoxie/Workspace/water/work-script/fuan_anlysis/water_plant_analysis.py`
- `/Users/zhengbiaoxie/Workspace/water/work-script/fuan_anlysis/water_plant_neural_network.py`

## 依赖包

新增依赖：
```json
{
  "recharts": "^2.x.x"
}
```

## 注意事项

1. 数据量要求：至少需要10个有效数据点才能进行分析
2. 异常值处理：系统会自动移除异常值，可能导致数据点减少
3. 时间范围：建议选择合理的时间范围以获得足够的数据样本
4. 模型评估：R²值越接近1表示模型拟合效果越好
5. 过拟合检查：如果训练集R²明显高于测试集R²，可能存在过拟合

## 未来改进方向

1. 增加更多回归算法（如随机森林、梯度提升等）
2. 支持时间序列分析
3. 增加交叉验证功能
4. 支持模型保存和加载
5. 增加更多可视化图表（如学习曲线、特征相关性矩阵等）
